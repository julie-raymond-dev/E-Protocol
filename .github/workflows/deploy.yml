name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

# Permissions sÃ©curisÃ©es
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  checks: write

# Ã‰viter les dÃ©ploiements concurrents
concurrency:
  group: "ci-cd-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  # ============================================================================
  # ğŸ§ª Ã‰TAPE 1: TESTS ET VALIDATION
  # ============================================================================
  test-and-validate:
    name: ğŸ§ª Test & Validate
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Cache dependencies
        id: cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          
      - name: ğŸ“¦ Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci --audit --fund=false
        
      - name: ğŸ” Run ESLint
        run: |
          echo "ğŸ” Running ESLint validation..."
          npm run lint
        
      - name: ğŸ—ï¸ Test build
        run: |
          echo "ğŸ—ï¸ Testing build process..."
          npm run build
          echo "âœ… Build test successful"

  # ============================================================================
  # ğŸ”’ Ã‰TAPE 2: AUDIT DE SÃ‰CURITÃ‰
  # ============================================================================
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: test-and-validate
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Restore dependencies
        run: npm ci --audit --fund=false

      - name: ï¿½ï¸ Run security audit
        run: |
          echo "ğŸ›¡ï¸ Running security audit..."
          npm audit --audit-level=moderate
          
      - name: ğŸ“Š Generate security report
        run: |
          echo "ğŸ“Š Generating security report..."
          npm audit --json > security-report.json || true
          
      - name: ğŸ“¤ Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_number }}
          path: security-report.json
          retention-days: 30

  # ============================================================================
  # ğŸš¦ Ã‰TAPE 3: PERFORMANCE (PR uniquement)
  # ============================================================================
  performance-check:
    name: ğŸš¦ Performance Check
    runs-on: ubuntu-latest
    needs: test-and-validate
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ï¿½ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for Lighthouse
        run: npm run build

      - name: ğŸš¦ Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun || echo "Lighthouse CI completed with warnings"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # ğŸš€ Ã‰TAPE 4: DÃ‰PLOIEMENT (main branch uniquement)
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [test-and-validate, security-audit]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci --audit --fund=false
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
          VITE_AUTH0_DOMAIN: ${{ secrets.VITE_AUTH0_DOMAIN }}
          VITE_AUTH0_CLIENT_ID: ${{ secrets.VITE_AUTH0_CLIENT_ID }}
          
      - name: ğŸ”’ Security check - Verify dist folder
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist folder not found"
            exit 1
          fi
          echo "âœ… Build successful: dist folder exists"
          ls -la dist/
          du -sh dist/
          
      - name: ğŸ›¡ï¸ Setup Pages security
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Deployment summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“ URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ—ï¸ Build size: $(du -sh dist/ | cut -f1)"
          echo "â° Deployed at: $(date)"

  # ============================================================================
  # ğŸ¤– Ã‰TAPE 5: AUTO-MERGE DEPENDABOT (optionnel)
  # ============================================================================
  auto-merge-dependabot:
    name: ğŸ¤– Auto-merge Dependabot
    runs-on: ubuntu-latest
    needs: [test-and-validate, security-audit]
    if: github.actor == 'dependabot[bot]' && github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ¤– Enable auto-merge for Dependabot PRs
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
